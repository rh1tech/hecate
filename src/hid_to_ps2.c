#include "hid_to_ps2.h"
#include "ps2lib.h"
#include <stdio.h>

// USB HID to PS/2 Scancode Set 2 translation table
// Index = HID keycode, Value = PS/2 scancode (0xFF = extended key needing E0 prefix)
// Extended keys are marked with high bit set (0x80 | scancode)

// Standard keys (no E0 prefix)
static const uint8_t hid_to_ps2_table[256] = {
    // 0x00 - 0x0F
    0x00,       // 0x00: Reserved
    0x00,       // 0x01: ErrorRollOver
    0x00,       // 0x02: POSTFail
    0x00,       // 0x03: ErrorUndefined
    0x1C,       // 0x04: A
    0x32,       // 0x05: B
    0x21,       // 0x06: C
    0x23,       // 0x07: D
    0x24,       // 0x08: E
    0x2B,       // 0x09: F
    0x34,       // 0x0A: G
    0x33,       // 0x0B: H
    0x43,       // 0x0C: I
    0x3B,       // 0x0D: J
    0x42,       // 0x0E: K
    0x4B,       // 0x0F: L
    
    // 0x10 - 0x1F
    0x3A,       // 0x10: M
    0x31,       // 0x11: N
    0x44,       // 0x12: O
    0x4D,       // 0x13: P
    0x15,       // 0x14: Q
    0x2D,       // 0x15: R
    0x1B,       // 0x16: S
    0x2C,       // 0x17: T
    0x3C,       // 0x18: U
    0x2A,       // 0x19: V
    0x1D,       // 0x1A: W
    0x22,       // 0x1B: X
    0x35,       // 0x1C: Y
    0x1A,       // 0x1D: Z
    0x16,       // 0x1E: 1
    0x1E,       // 0x1F: 2
    
    // 0x20 - 0x2F
    0x26,       // 0x20: 3
    0x25,       // 0x21: 4
    0x2E,       // 0x22: 5
    0x36,       // 0x23: 6
    0x3D,       // 0x24: 7
    0x3E,       // 0x25: 8
    0x46,       // 0x26: 9
    0x45,       // 0x27: 0
    0x5A,       // 0x28: Enter
    0x76,       // 0x29: Escape
    0x66,       // 0x2A: Backspace
    0x0D,       // 0x2B: Tab
    0x29,       // 0x2C: Space
    0x4E,       // 0x2D: - (minus)
    0x55,       // 0x2E: = (equal)
    0x54,       // 0x2F: [ (left bracket)
    
    // 0x30 - 0x3F
    0x5B,       // 0x30: ] (right bracket)
    0x5D,       // 0x31: \ (backslash)
    0x5D,       // 0x32: # (non-US)
    0x4C,       // 0x33: ; (semicolon)
    0x52,       // 0x34: ' (apostrophe)
    0x0E,       // 0x35: ` (grave)
    0x41,       // 0x36: , (comma)
    0x49,       // 0x37: . (period)
    0x4A,       // 0x38: / (slash)
    0x58,       // 0x39: Caps Lock
    0x05,       // 0x3A: F1
    0x06,       // 0x3B: F2
    0x04,       // 0x3C: F3
    0x0C,       // 0x3D: F4
    0x03,       // 0x3E: F5
    0x0B,       // 0x3F: F6
    
    // 0x40 - 0x4F
    0x83,       // 0x40: F7
    0x0A,       // 0x41: F8
    0x01,       // 0x42: F9
    0x09,       // 0x43: F10
    0x78,       // 0x44: F11
    0x07,       // 0x45: F12
    0x80 | 0x7C,// 0x46: PrintScreen (E0 7C)
    0x7E,       // 0x47: Scroll Lock
    0x00,       // 0x48: Pause (special handling)
    0x80 | 0x70,// 0x49: Insert (E0 70)
    0x80 | 0x6C,// 0x4A: Home (E0 6C)
    0x80 | 0x7D,// 0x4B: Page Up (E0 7D)
    0x80 | 0x71,// 0x4C: Delete (E0 71)
    0x80 | 0x69,// 0x4D: End (E0 69)
    0x80 | 0x7A,// 0x4E: Page Down (E0 7A)
    0x80 | 0x74,// 0x4F: Right Arrow (E0 74)
    
    // 0x50 - 0x5F
    0x80 | 0x6B,// 0x50: Left Arrow (E0 6B)
    0x80 | 0x72,// 0x51: Down Arrow (E0 72)
    0x80 | 0x75,// 0x52: Up Arrow (E0 75)
    0x77,       // 0x53: Num Lock
    0x80 | 0x4A,// 0x54: Keypad / (E0 4A)
    0x7C,       // 0x55: Keypad *
    0x7B,       // 0x56: Keypad -
    0x79,       // 0x57: Keypad +
    0x80 | 0x5A,// 0x58: Keypad Enter (E0 5A)
    0x69,       // 0x59: Keypad 1
    0x72,       // 0x5A: Keypad 2
    0x7A,       // 0x5B: Keypad 3
    0x6B,       // 0x5C: Keypad 4
    0x73,       // 0x5D: Keypad 5
    0x74,       // 0x5E: Keypad 6
    0x6C,       // 0x5F: Keypad 7
    
    // 0x60 - 0x6F
    0x75,       // 0x60: Keypad 8
    0x7D,       // 0x61: Keypad 9
    0x70,       // 0x62: Keypad 0
    0x71,       // 0x63: Keypad .
    0x61,       // 0x64: Non-US \
    0x80 | 0x2F,// 0x65: Application (E0 2F)
    0x00,       // 0x66: Power
    0x00,       // 0x67: Keypad =
    0x00,       // 0x68: F13
    0x00,       // 0x69: F14
    0x00,       // 0x6A: F15
    0x00,       // 0x6B: F16
    0x00,       // 0x6C: F17
    0x00,       // 0x6D: F18
    0x00,       // 0x6E: F19
    0x00,       // 0x6F: F20
    
    // 0x70 - 0xE7 (mostly zeros, modifiers at end)
    [0x70 ... 0xDF] = 0x00,
    
    // Modifiers (0xE0 - 0xE7)
    0x14,       // 0xE0: Left Control
    0x12,       // 0xE1: Left Shift
    0x11,       // 0xE2: Left Alt
    0x80 | 0x1F,// 0xE3: Left GUI (E0 1F)
    0x80 | 0x14,// 0xE4: Right Control (E0 14)
    0x59,       // 0xE5: Right Shift
    0x80 | 0x11,// 0xE6: Right Alt (E0 11)
    0x80 | 0x27,// 0xE7: Right GUI (E0 27)
    
    // Rest zeros
    [0xE8 ... 0xFF] = 0x00,
};

uint8_t hid_to_ps2(uint8_t hid_keycode, bool *extended) {
    uint8_t ps2 = hid_to_ps2_table[hid_keycode];
    
    if (ps2 & 0x80) {
        *extended = true;
        return ps2 & 0x7F;
    } else {
        *extended = false;
        return ps2;
    }
}

void send_ps2_key(uint8_t hid_keycode, bool pressed) {
    bool extended;
    uint8_t ps2_code = hid_to_ps2(hid_keycode, &extended);
    
    if (ps2_code == 0) {
        // No mapping for this key
        return;
    }
    
    printf("HID 0x%02X -> PS/2 %s0x%02X %s\n", 
           hid_keycode, 
           extended ? "E0 " : "", 
           ps2_code, 
           pressed ? "MAKE" : "BREAK");
    
    if (pressed) {
        // Make code
        if (extended) {
            ps2lib_send_byte(0xE0);
        }
        ps2lib_send_byte(ps2_code);
    } else {
        // Break code
        if (extended) {
            ps2lib_send_byte(0xE0);
        }
        ps2lib_send_byte(0xF0);  // Break prefix
        ps2lib_send_byte(ps2_code);
    }
}
